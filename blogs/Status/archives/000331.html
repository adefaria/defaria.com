<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
   <meta name="generator" content="Movable Type 5.2.3" />

   <link rel="stylesheet" href="http://defaria.com/blogs/Status/styles-site.css" type="text/css" />
   <link rel="alternate" type="application/atom+xml" title="Atom" href="http://defaria.com/blogs/Status/atom.xml" />
   <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="http://defaria.com/blogs/Status/index.xml" />

   <title>Status for Andrew DeFaria: Bluecat RH 8.0 port</title>

   <link rel="start" href="http://defaria.com/blogs/Status/" title="Home" />
   <link rel="prev" href="http://defaria.com/blogs/Status/archives/000330.html" title="Hybrid OS" />
   <link rel="next" href="http://defaria.com/blogs/Status/archives/000332.html" title="LOS178 3.0.0" />

   

   

   <script type="text/javascript" src="http://defaria.com/blogs/Status/mt-site.js"></script>
</head>
<body class="layout-one-column" onload="individualArchivesOnLoad(commenter_name)">
   <div id="container">
      <div id="container-inner" class="pkg">

         <div id="banner">
            <div id="banner-inner" class="pkg">
               <h1 id="banner-header"><a href="http://defaria.com/blogs/Status/" accesskey="1">Status for Andrew DeFaria</a></h1>
               <h2 id="banner-description">Searchable status reports and work log</h2>
            </div>
         </div>

         <div id="pagebody">
            <div id="pagebody-inner" class="pkg">
               <div id="alpha">
                  <div id="alpha-inner" class="pkg">

                     <p class="content-nav">
                        <a href="http://defaria.com/blogs/Status/archives/000330.html">&laquo; Hybrid OS</a> |
                        <a href="http://defaria.com/blogs/Status/">Main</a>
                        | <a href="http://defaria.com/blogs/Status/archives/000332.html">LOS178 3.0.0 &raquo;</a>
                     </p>

                     <a id="a000331"></a>
                     <div class="entry" id="entry-331">
                        <h3 class="entry-header">Bluecat RH 8.0 port</h3>
                        <div class="entry-content">
                           <div class="entry-body">
                              <p>This status entry is to hold a log of the issues and resolutions for getting the Bluecat build process from the ancient RH 6.1 to the <i>a little less ancient</i> RH 8.0.</p>

<ol>
  <li>Fun with eval, echo and new shell</li>

  <li>Bug in rpm configure</li>

  <li>Static vs. Shared</li>
</ol>

                           </div>
                           <div id="more" class="entry-more">
                              <h3>Fun with eval, echo and new shell</h3>

<p>One of the things that the Bluecat do_it script does is to define the series of "steps" that need to be performed in terms of command lines in variables. Later on the $BUILD_STEP is evaluated to determine which set of commands need to be done as follows:</p>

<div class="code"><pre>
echo "---- Step $BUILD_STEP started at `date` ----"
su $BUILD_CMD_OWNER -c "mkdir -p $LOGS_PREFIX/step${BUILD_STEP}"
cmd=`eval echo $"STEP${BUILD_STEP}_CMD"`
su $BUILD_CMD_OWNER -c "$cmd $*"
</pre></div>

<p>Effectively the name of the environment variable holding the proper command(s) for the step is composed with the echo portion. The eval statement is used to "evaluate" that environment variable thus storing the string of commands into the environment variable cmd. This works well in past versions of the OS but it fails in RH 8.0. First here's the behavior on RH 6.1:</p>

<div class="code"><pre>
<font color="blue"><b>RH6.1:</b></font><u>export STEP1_CMD="ls /tmp"</u>
<font color="blue"><b>RH6.1:</b></font><u>export BUILD_STEP=1</u>
<font color="blue"><b>RH6.1:</b></font><u>echo $"STEP${BUILD_STEP}_CMD"</u>
$STEP1_CMD
</pre></div>

<p>However hears the same commands on RH8.0:</p>

<div class="code"><pre>
<font color="red"><b>RH8.0:</b></font><u>export STEP1_CMD="ls /tmp"</u>
<font color="red"><b>RH8.0:</b></font><u>export BUILD_STEP=1</u>
<font color="red"><b>RH8.0:</b></font><u>echo $"STEP${BUILD_STEP}_CMD"</u>
STEP1_CMD
</pre></div>

<p>As you can see the result is missing a $. Prepending a leading \ before the $ fixes this. Adding in the eval portion also works:</p>

<div class="code"><pre>
<font color="red"><b>RH8.0:</b></font><u>eval echo \$"STEP${BUILD_STEP}_CMD"</u>
ls /tmp
</pre></div>

<p>However when this is assigned to another environment variable (i.e. cmd) the result is not correct:</p>

<div class="code"><pre>
<font color="red"><b>RH8.0:</b></font><u>cmd=`eval echo \$"STEP${BUILD_STEP}_CMD"`</u>
<font color="red"><b>RH8.0:</b></font><u>echo $cmd</u>
STEP1_CMD
</pre></div>

<p>Subsituting the syntax of $(<command>) for `<command` however does work:</p>

<div class="code"><pre>
<font color="red"><b>RH8.0:</b></font><u>cmd=$(eval echo \$"STEP${BUILD_STEP}_CMD")</u>
<font color="red"><b>RH8.0:</b></font><u>echo $cmd</u>
ls /tmp
</pre></div>

<p>Note that the shell (bash) has been majorly updated for RH8.0:</p>

<div class="code"><pre>
<font color="blue"><b>RH6.1:</b></font><u>bash -version</u>
GNU bash, version 1.14.7(1)
</pre></div>

<p>Versus:</p>

<div class="code"><pre>
<font color="red"><b>RH8.0:</b></font><u>bash -version</u>
GNU bash, version 2.05b.0(1)-release (i686-pc-linux-gnu)
Copyright (C) 2002 Free Software Foundation, Inc.
</pre></div>

<p>Please note that this new syntax also works flawlessly on the older RH 6.1.</p>

<h3>Bug in rpm configure</h3>

<p>When trying to build Bluecat on RH 8.0 and running mktools (to build the local gnutools) I get the following:</p>

<div class="code"><pre>
[int@europa make]$ autoreconf -f -i
autoreconf: `aclocal.m4' is updated
Makefile.am: installing `./depcomp'
WARNING: Using auxiliary files such as `acconfig.h', `config.h.bot'
WARNING: and `config.h.top', to define templates for `config.h.in'
WARNING: is deprecated and discouraged.

WARNING: Using the third argument of `AC_DEFINE' and
WARNING: `AC_DEFINE_UNQUOTED' allows to define a template without
WARNING: `acconfig.h':

WARNING:   AC_DEFINE([NEED_MAIN], 1,
WARNING:             [Define if a function `main' is needed.])

WARNING: More sophisticated templates can also be produced, see the
WARNING: documentation.
autoheader-2.53: `config.h.in' is updated
</pre></div>

<p>Further, after running configure I get the following odd file in /usr/local/bluecat/eng/bluecat/make/.deps: remote-$(REMOTE).Po which causes the make to fail:</p>

<div class="code"><pre>
[int@europa make]$ make
Makefile:329: .deps/remote-stub.Po: No such file or directory
make: *** No rule to make target `.deps/remote-stub.Po'.  Stop.
</pre></div>

<p>Renaming .deps/remote-$(REMOTE).Po -> .deps/remote-stub.Po allows the make to proceed.</p>

<h3>Static vs. Shared - Cannot find -lnss_dns</h3>

<p>During the first real build step, step 2, the build fails when trying to build rpm. ld is unable to find the library nss_dns. Initial investigation shows that there is a nss_dns libs under /usr/lib as .so files but there is no .a file on RH 8.0. There is a .a file on RH 6.1 in /usr/lib. Apparently RH 8.0 no longer offers archive libraries for this. The solution to this problem is to pass -shared to gcc.</p>

<p>The specific gcc command line is:</p>

<div class="code"><pre>
<font color="blue"><b>int@europa tools:</b></font><u>pwd</u>
/var/tmp/rpm-4.2/tools
<font color="blue"><b>int@europa tools:</b></font><u>gcc -Wl,--verbose -O2 -D_GNU_SOURCE -D_REENTRANT -Wall -Wpointer-arith -Wstrict-prototypes -Wmissing-prototypes -Wno-char-subscripts -o rpmgraph <font color="red"><b>-static</b></font> rpmgraph.o  ../lib/.libs/librpm.a /var/tmp/rpm-4.2/rpmdb/.libs/librpmdb.a -L/var/tmp/rpm-4.2/zlib -L/usr/local/lib /var/tmp/rpm-4.2/rpmio/.libs/librpmio.a /var/tmp/rpm-4.2/popt/.libs/libpopt.a ../beecrypt/.libs/libbeecrypt.a -lrt -lpthread -lc -lnss_dns -lnss_files -lresolv</u>
...
(/usr/lib/gcc-lib/i386-redhat-linux/3.2/../../../libc.a)truncate64.o
(/usr/lib/gcc-lib/i386-redhat-linux/3.2/../../../libc.a)truncate.o
attempt to open /var/tmp/rpm-4.2/zlib/libnss_dns.a failed
attempt to open /usr/local/lib/libnss_dns.a failed
attempt to open /usr/lib/gcc-lib/i386-redhat-linux/3.2/libnss_dns.a failed
attempt to open /usr/lib/gcc-lib/i386-redhat-linux/3.2/../../../libnss_dns.a failed
attempt to open /usr/i386-redhat-linux/lib/libnss_dns.a failed
attempt to open /usr/lib/libnss_dns.a failed
attempt to open /usr/local/lib/libnss_dns.a failed
attempt to open /lib/libnss_dns.a failed
collect2: ld returned 1 exit status
</pre></div>

<p>This is probably due to the -static above. Removing -static fixes this. The question is: Is it OK to remove -static? Second question is how?</p>




                           </div>
                        </div>
                        <p class="entry-footer">
                           <span class="post-footers">Posted by  on April  7, 2005 10:39 AM</span> <span class="separator">|</span> <a class="permalink" href="http://defaria.com/blogs/Status/archives/000331.html">Permalink</a>
                        </p>
                     </div>

                     

                     
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
</body>
</html>
