<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
   <meta name="generator" content="Movable Type 5.2.3" />

   <link rel="stylesheet" href="http://defaria.com/blogs/Status/styles-site.css" type="text/css" />
   <link rel="alternate" type="application/atom+xml" title="Atom" href="http://defaria.com/blogs/Status/atom.xml" />
   <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="http://defaria.com/blogs/Status/index.xml" />

   <title>Status for Andrew DeFaria: Load Balancing Redirection</title>

   <link rel="start" href="http://defaria.com/blogs/Status/" title="Home" />
   <link rel="prev" href="http://defaria.com/blogs/Status/archives/000574.html" title="JVM Stack/Heap Sizes" />
   <link rel="next" href="http://defaria.com/blogs/Status/archives/000576.html" title="Redirecting on ErrorDocument" />

   

   

   <script type="text/javascript" src="http://defaria.com/blogs/Status/mt-site.js"></script>
</head>
<body class="layout-one-column" onload="individualArchivesOnLoad(commenter_name)">
   <div id="container">
      <div id="container-inner" class="pkg">

         <div id="banner">
            <div id="banner-inner" class="pkg">
               <h1 id="banner-header"><a href="http://defaria.com/blogs/Status/" accesskey="1">Status for Andrew DeFaria</a></h1>
               <h2 id="banner-description">Searchable status reports and work log</h2>
            </div>
         </div>

         <div id="pagebody">
            <div id="pagebody-inner" class="pkg">
               <div id="alpha">
                  <div id="alpha-inner" class="pkg">

                     <p class="content-nav">
                        <a href="http://defaria.com/blogs/Status/archives/000574.html">&laquo; JVM Stack/Heap Sizes</a> |
                        <a href="http://defaria.com/blogs/Status/">Main</a>
                        | <a href="http://defaria.com/blogs/Status/archives/000576.html">Redirecting on ErrorDocument &raquo;</a>
                     </p>

                     <a id="a000575"></a>
                     <div class="entry" id="entry-575">
                        <h3 class="entry-header">Load Balancing Redirection</h3>
                        <div class="entry-content">
                           <div class="entry-body">
                              <ul>
  <li>Implemented a load balancing redirection scheme for cqweb</li>
</ul>
                           </div>
                           <div id="more" class="entry-more">
                              <h2>Load Balancing CQ Web Servers based on Number of CQ Web Users</h2>

<p>The task at hand was to write a redirector that load balances amongst a number of CQ Web servers based on the number of CQ Web Users currently on each server. Additionally, based on how the user came into the CQ Web server farm, redirect them to the proper schema.</p>

<h3>Determining Load</h3>

<p>The old IIS CQ Web Server used to allow you to query the number of active CQ Web Users. The new Apache/Tomcat server only allows admins to do this. Additionally the admin need to be logged in, thus have a valid token. IBM/Rational suggests using Apache's server-status URL to determine load. However that only displays number of Apache requests in progress not number of CQ Web Users.</p>

<p>If ExtendedStatus is turned on then Apache lists each connection and the URL they are working on. By filtering "GET /cqweb" we can get a rough estimate of the number of CQ Web Users. There is a problem in that the redirector script cannot query the same web server that it's running on. Additionally this information can only be obtained if ExtendedStatus is turned on.</p>

<h2>Algorithm for selecting a server</h2>

<p>The algorithm for selecting a non busy server is described as:</p>

<p>Pick a lightly loaded server out of the pool. Note that if a server is not running with ExtendedStatus on then $cq_users will be undef. This is different than the case where the server has ExtendedStatus on but there just aren't any CQ Web users (which would be denoted by $cq_users = 0). Thus we may have the condition where:

<table cellspacing=0 cellpadding=2 border=1>
  <tbody>
    <tr>
      <th>Server</th>
      <th>cq_users</th>
      <th>ExtendedStatus</th>
    </tr>
    <tr>
      <td>server1</td>
      <td>undef</td>
      <td>off</td>
    </tr>
    <tr>
      <td>server2</td>
      <td>20</td>
      <td>on</td>
    </tr>
    <tr>
      <td>server3</td>
      <td>0</td>
      <td>on</td>
    </tr>
    <tr>
      <td>server4</td>
      <td>10</td>
      <td>on</td>
    </tr>
  </tbody>
<table>

<p>In such a case we wish to pick server3 since it has no current CQ web users.

<p>The algorithm used here will be to remove all servers from the pool who are not running with ExtendedStatus on since we cannot reliably tell how loaded the server is from the standpoint of CQ Web users. If, however, no servers have ExtendedStatus on (thus all $cq_users return as undef) then we will consider the $nbr_apache_requests. IOW $nbr_apache_requests is not equivalent with $cq_users and thus they cannot be compared together. But if no server is running with ExtendedStatus on we need to pick something!</p>

<p><b>Note:</b> If $random then a server is simply randomly chosen.</p>

<p>Unfortunately, given this algorithm, if we had the following situation:</p>
 
<table cellspacing=0 cellpadding=2 border=1>
  <tbody>
    <tr>
      <th>Server</th>
      <th>cq_users</th>
      <th>ExtendedStatus</th>
    </tr>
    <tr>
      <td>server1</td>
      <td>undef</td>
      <td>on</td>
    </tr>
    <tr>
      <td>server2</td>
      <td>undef</td>
      <td>off</td>
    </tr>
    <tr>
      <td>server3</td>
      <td>undef</td>
      <td>off</td>
    </tr>
    <tr>
      <td>server4</td>
      <td>10</td>
      <td>on</td>
    </tr>
  </tbody>
<table>

<p>Then this algorithm will always return server4.</p>

<p><b><font color=red>Important Note:</font></b> The web server doing the redirection cannot be queried. Attempting to do so hangs! Therefore it cannot participate in the server pool. It is recommended that another web server be set up as the redirector and the DNS name cqweb assigned to it. This web server can, however, participate by being a Clearquest Request Manager.</p>

<h3>Random Redirection</h3>

<p>The script can also redirect randomly instead of relying on load of CQ Web Users. Currently there are 3 servers in the pool. Only one of them has ExtendedStatus turned on. As such redirecting by load will always resolve to the one server using, the one running with ExtendedStatus on. This is not good. So currently it just picks a server randomly from the pool. This behavior is controlled by the <tt>lb</tt> parameter (currently defaulted to off meaning pick server randomly).

<h3>Defining the Server Pool</h3>

<p>The server pool is defined by a small file, servers.cfg, which simply list the servers participating in the pool. Servers can be added or removed dynamically.</p>

<h3>Mapping Redirection</h3>

<p>In the past users went to http://cqweb/&lt;area&gt;. These <areas> were HTML files in the DocumentRoot which redirected to a series of redirection scripts. It was hoped that HTTP_REFERER could be used to determine where to redirect the visitor. Unfortunately HTTP_REFERER is not guaranteed and indeed it's undefined on the web servers!</p>

<p>Instead one must specify the <tt>group</tt> parameter to the redirector script. The script then maintains a map between &lt;areas&gt; -> Schema/ContextIDs. If the group is not specified or not in the map then the user is redirected to the main login page. This is not viewed as a hardship because we need redirecting &lt;area&gt; files anyway. The new form of redirecting &lt;area&gt; file is:

<div class=code><pre>
&lt;html&gt;
&lt;head&gt;
&ltmdeta http-equiv="refresh" content="0; url=http://cqweb.itg.ti.com/cgi-bin/redirect.pl?group=&lt<i>area</i>&gt;&gt;
&lt;/head&gt;
</pre></div>

<h3>Redirect Map</h3>

<p>The redirect map, stored in redirect.map, is a file of key/value pairs. For example:</p>

<div class=code><pre>
CMDT:           &schema=CMDT.2003.06.00&contextid=CMDT
CSSD:           &schema=omap.2002.05.00&contextid=OMAPS
DLP-Play:       &schema=DLP.2003.06.00&contextid=Play
DLP:            &schema=DLP.2003.06.00&contextid=DLP
DMD-p:          &schema=DLP.2003.06.00&contextid=DMD-p
DMD:            &schema=DLP.2003.06.00&contextid=DMD
GCM:            &schema=CMDT.2003.06.00&contextid=GCM
HPALP:          &schema=HPA_MKT_LP&contextid=HPALP
LDM:            &schema=CMDT.2003.06.00&contextid=LDM
NV:             &schema=CMDT.2003.06.00&contextid=NV
SDO:            &schema=SDS.2003.06.00&contextid=SDSCM
SDO_TEST:       &schema=SDS_TST_DEV&contextid=SDSCM
WiMax:          &schema=WiMax.SR5&contextid=WiMax
mDTV:           &schema=mDTV.2003.06.00&contextid=MDTV
mDTV_play:      &schema=mDTV.2003.06.00&contextid=PLAY
</pre></div>

<h3>Parameters for redirect.pl</h3>

<p>The following parameters, specified in the URL, are supported by redirect.pl:</p>

<dl>
  <dt>group</dt>
    <dd>Specifies the key into the redirect.map for the schema/contextid. If not specified then defaults to main login page of the selected server</dd>

  <dt>lb</dt>
    <dd>If set then load balancing is attempted based on ExtendedStatus and CQ Web Users as described above. Default: undefined (off)</dd>

  <dt>debug</dt>
    <dd>If specified the user is not redirected rather debugging information is output.</dd>
</dl>
                           </div>
                        </div>
                        <p class="entry-footer">
                           <span class="post-footers">Posted by  on September 29, 2006  2:35 PM</span> <span class="separator">|</span> <a class="permalink" href="http://defaria.com/blogs/Status/archives/000575.html">Permalink</a>
                        </p>
                     </div>

                     

                     
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
</body>
</html>
