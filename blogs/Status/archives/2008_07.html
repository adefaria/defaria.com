<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
   <meta name="generator" content="Movable Type 5.2.3" />

   <link rel="stylesheet" href="http://defaria.com/blogs/Status/styles-site.css" type="text/css" />
   <link rel="alternate" type="application/atom+xml" title="Atom" href="http://defaria.com/blogs/Status/atom.xml" />
   <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="http://defaria.com/blogs/Status/index.xml"$>" />

   <title>Status for Andrew DeFaria: July 2008 Archives</title>

   <link rel="start" href="http://defaria.com/blogs/Status/" title="Home" />
   <link rel="prev" href="http://defaria.com/blogs/Status/archives/2008_05.html" title="May 2008" />
   <link rel="next" href="http://defaria.com/blogs/Status/archives/2009_04.html" title="April 2009" />
</head>
<body class="layout-one-column">
   <div id="container">
      <div id="container-inner" class="pkg">

         <div id="banner">
            <div id="banner-inner" class="pkg">
               <h1 id="banner-header"><a href="http://defaria.com/blogs/Status/" accesskey="1">Status for Andrew DeFaria</a></h1>
               <h2 id="banner-description">Searchable status reports and work log</h2>
            </div>
         </div>

         <div id="pagebody">
            <div id="pagebody-inner" class="pkg">
               <div id="alpha">
                  <div id="alpha-inner" class="pkg">
                     
                     <p class="content-nav">
                        <a href="http://defaria.com/blogs/Status/archives/2008_05.html">&laquo; May 2008</a> |
                        <a href="http://defaria.com/blogs/Status/">Main</a>
                        | <a href="http://defaria.com/blogs/Status/archives/2009_04.html">April 2009 &raquo;</a>
                     </p>
                     
                     
                     <!--
<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
         xmlns:trackback="http://madskills.com/public/xml/rss/module/trackback/"
         xmlns:dc="http://purl.org/dc/elements/1.1/">
<rdf:Description
    rdf:about="http://defaria.com/blogs/Status/archives/2008_07.html#entry-000705"
    trackback:ping="http://defaria.com/mt/mt-tb.cgi/92"
    dc:title="Pre-shared ssh keys"
    dc:identifier="http://defaria.com/blogs/Status/archives/2008_07.html#entry-000705"
    dc:subject="General Dynamics"
    dc:description="Issue Gantry mentioned that we are still having issues with pre-shared key access to various systems using pswit as the log in. This email will serve to document how pre-share key access works, how we are using it here and..."
    dc:creator=""
    dc:date="2008-07-30T17:25:01-06:00" />
</rdf:RDF>
-->


                     <h2 class="date-header">July 30, 2008</h2>
                     <a id="a000705"></a>
                     <div class="entry" id="entry-705">
                        <h3 class="entry-header">Pre-shared ssh keys</h3>
                        <div class="entry-content">
                           <div class="entry-body">
                              <h3>Issue</h3>

<p>Gantry mentioned that we are still having issues with pre-shared key access to various systems using pswit as the log in. This email will serve to document how pre-share key access works, how we are using it here and how the process is breaking down. We could attempt to script it but there are challenges and issues with that, specifically the
gathering of ssh keys requires root access. Or we could simply learn how it works and follow a process, which I'll suggest.</p>

<h3>How pre-shared ssh access works</h3>

<p>In order to ssh to another machine as another user (or any user including yourself) using a pre-shared key you eed have a key to share. Therefore you need to generate an ssh key. We tend to use DSA keys as they are stronger. The process of generating an ssh key will not be discussed here but if you have one then in your home directory you'll have a file name id_dsa.pub under your .ssh directory.</p>

<p>The contents of this file needs to be placed into the "receiving" user's ~/.ssh/authorized_keys file. The act of doing this specifically states "I know &lt;x&gt; and I will allow him to ssh into this machine as me". So if I (p6258c) want to ssh to seast1 as pswit I need to get my DSA key (~p6258c/.ssh/id_dsa.pub) into pswit's authorized_keys file (~pswit/.ssh/authorized_keys).</p>

<h3>NIS domain/Windows considerations</h3>

<p>An additional complication here is that pswit in the RAN NIS domain != pswit in the RANTEST NIS domain. So If I wanted to be able to ssh as pswit to ranray I'd need to <b>also</b> get my DSA key (generated on the RAN NIS domain) into ~pswit/.ssh/authorized_keys. remember pswit's home directory on ranray != pswit's home directory on seast1. Both entities (the pswit user ID in RAN and the pswit user ID in RANTEST) are distinct and different users.</p>

<p>A further complication is that pswit on the 11 Windows machines are all local users to those Windows machines. The Windows machines are in the set (rantm50[1..7], sim[1..4]).</p>

<h3>Gathering ssh keys and building a combined authorzied_keys file</h3>

<p>So we need to collect ssh keys from multiple users, in multiple Unix NIS domains to multiple machines. In the past what I did was to gather all of the ssh keys for the users on the RAN side into an authorized_keys file named ran and then gathered all of the ssh keys for the users on the RANTEST side in an authorized_keys file named east. Normally an ssh key would say "&lt;user&gt;@&lt;machine&gt;" where &lt;machine&gt; is the machine which ssh-keygen was run. To avoid confusion I changed the comment at the end of each key to say "&lt;user&gt;@ran" or "&lt;user&gt;@east" in the respective files. Then I would concatenate the two files, ran and east, to one authorized keys file. This file was then checked into Clearcase under rantest_auto/config.</p>

<h3>Dissemination</h3>

<p>Since the home directory for pswit is always the same home directory for all machines in the RAN domain, and since the same is true in the RANTEST domain, we need only set authorized_keys twice, once in RAN and once in RANTEST, for the Unix side. However we need to also disseminate keys to 11 Windows boxes. Here's, effectively, how I do that.</p>

<div class="code">
<pre>$ machines="\
&gt;  ranray\
&gt;  seast1\
&gt;  rantm501\
&gt;  rantm502\
&gt;  rantm503\
&gt;  rantm504\
&gt;  rantm505\
&gt;  rantm506\
&gt;  rantm507\
&gt;  sim1\
&gt;  sim2\
&gt;  sim3\
&gt;  sim4\
&gt; "

$for machine in $machines; do
  scp -q authorized_keys <a class="moz-txt-link-abbreviated" href="mailto:pswit@$machine:.ssh">pswit@$machine:.ssh</a>
done
</pre>
</div>

<p>This disseminates the authorized_keys file to all the appropriate machines.</p>

<h3>Current state</h3>

<p>Currently, gathering up all authorized_keys files in a reverse fashion to the above, we have:</p>

<table align="center" border="1" cellpadding="2" cellspacing="0"
 width="75%">
  <tbody>
    <tr>
      <th bgcolor="teal" valign="top"><font color="#ffffff">Region/Machine<br>
      </font></th>
      <th bgcolor="teal" valign="top"><font color="#ffffff"># of Entries<br>
      </font></th>
      <th bgcolor="teal" valign="top"><font color="#ffffff">Comments<br>
      </font></th>
    </tr>
    <tr>
      <td align="center" valign="top">master<br>
      </td>
      <td align="center" valign="top">92<br>
      </td>
      <td valign="top">Master authorized_keys file from Clearcase<br>
      </td>
    </tr>
    <tr>
      <td align="center" valign="top">ran<br>
      </td>
      <td align="center" valign="top">95<br>
      </td>
      <td valign="top">authorized_keys file from RAN<br>
      </td>
    </tr>
    <tr>
      <td align="center" valign="top">rantm501<br>
      </td>
      <td align="center" valign="top">92<br>
      </td>
      <td valign="top"><br>
      </td>
    </tr>
    <tr>
      <td align="center" valign="top">rantm502</td>
      <td align="center" valign="top">92</td>
      <td valign="top"><br>
      </td>
    </tr>
    <tr>
      <td align="center" valign="top">rantm503</td>
      <td align="center" valign="top">92</td>
      <td valign="top"><br>
      </td>
    </tr>
    <tr>
      <td align="center" valign="top">rantm504</td>
      <td align="center" valign="top">92</td>
      <td valign="top"><br>
      </td>
    </tr>
    <tr>
      <td align="center" valign="top">rantm505</td>
      <td align="center" valign="top">92</td>
      <td valign="top"><br>
      </td>
    </tr>
    <tr>
      <td align="center" valign="top">rantm506</td>
      <td align="center" valign="top">92</td>
      <td valign="top"><br>
      </td>
    </tr>
    <tr>
      <td align="center" valign="top">rantm507</td>
      <td align="center" valign="top">92</td>
      <td valign="top"><br>
      </td>
    </tr>
    <tr>
      <td align="center" valign="top">seast1<br>
      </td>
      <td align="center" valign="top">97</td>
      <td valign="top">authorized_keys file from RANTEST<br>
      </td>
    </tr>
    <tr>
      <td align="center" valign="top">sim1<br>
      </td>
      <td align="center" valign="top">93<br>
      </td>
      <td valign="top"><br>
      </td>
    </tr>
    <tr>
      <td align="center" valign="top">sim2<br>
      </td>
      <td align="center" valign="top">92<br>
      </td>
      <td valign="top"><br>
      </td>
    </tr>
    <tr>
      <td align="center" valign="top">sim3<br>
      </td>
      <td align="center" valign="top">92<br>
      </td>
      <td valign="top"><br>
      </td>
    </tr>
    <tr>
      <td align="center" valign="top">sim4<br>
      </td>
      <td align="center" valign="top">92<br>
      </td>
      <td valign="top"><br>
      </td>
    </tr>
  </tbody>
</table>

<p>The way to have pre-shared ssh key access working the best is for each Region/Machine to have the same amount of entries (actually the exact same authorized_keys file). But we can see that people are indiscriminately changing the authorized_keys file only in certain places causing confusion and causing the process to break down.</p>

<h3>Suggested process</h3>

<p>When somebody reports that they are having a problem with ssh access using a pre-shared key to become pswit on another machine they should submit a help desk ticket. The way to resolve the help desk ticket is to:</p>

<ol>
  <li>Generate this user's DSA ssh key (if required) on both the RAN
and the RANTEST NIS domains</li>
  <li>Change the host name associated with the key to "ran" or "east"
as appropriate</li>
  <li>Open a WOR in the RANTEST_Auto project and create a view</li>
  <li>Checkout the rantest_tools/config/authorized_keys file and edit
it appending the two DSA ssh keys</li>
  <li>Checkin and deliver the WOR</li>
  <li>Either execute the above code to disseminate the new
authorized_keys file or perhaps we could write a simple script to do it.<br>
  </li>
</ol>

<p>Comments?</p>
                              
                              <p class="entry-footer">
                                 <span class="post-footers">Posted by  at  5:25 PM</span> <span class="separator">|</span> <a class="permalink" href="http://defaria.com/blogs/Status/archives/000705.html">Permalink</a>
                                 
                                 | <a href="http://defaria.com/blogs/Status/archives/000705.html#trackback">TrackBacks (0)</a>
                              </p>
                           </div>
                        </div>
                     </div>
                     
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
</body>
</html>
