<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
   <meta name="generator" content="Movable Type 5.2.3" />

   <link rel="stylesheet" href="http://defaria.com/blogs/Status/styles-site.css" type="text/css" />
   <link rel="alternate" type="application/atom+xml" title="Atom" href="http://defaria.com/blogs/Status/atom.xml" />
   <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="http://defaria.com/blogs/Status/index.xml"$>" />

   <title>Status for Andrew DeFaria: September 24, 2006 - September 30, 2006 Archives</title>

   <link rel="start" href="http://defaria.com/blogs/Status/" title="Home" />
   <link rel="prev" href="http://defaria.com/blogs/Status/archives/week_2006_09_17.html" title="September 17, 2006 - September 23, 2006" />
   <link rel="next" href="http://defaria.com/blogs/Status/archives/week_2006_10_01.html" title="October  1, 2006 - October  7, 2006" />
</head>
<body class="layout-one-column">
   <div id="container">
      <div id="container-inner" class="pkg">

         <div id="banner">
            <div id="banner-inner" class="pkg">
               <h1 id="banner-header"><a href="http://defaria.com/blogs/Status/" accesskey="1">Status for Andrew DeFaria</a></h1>
               <h2 id="banner-description">Searchable status reports and work log</h2>
            </div>
         </div>

         <div id="pagebody">
            <div id="pagebody-inner" class="pkg">
               <div id="alpha">
                  <div id="alpha-inner" class="pkg">
                     
                     <p class="content-nav">
                        <a href="http://defaria.com/blogs/Status/archives/week_2006_09_17.html">&laquo; September 17, 2006 - September 23, 2006</a> |
                        <a href="http://defaria.com/blogs/Status/">Main</a>
                        | <a href="http://defaria.com/blogs/Status/archives/week_2006_10_01.html">October  1, 2006 - October  7, 2006 &raquo;</a>
                     </p>
                     
                     
                     

                     <h2 class="date-header">September 29, 2006</h2>
                     <a id="a000575"></a>
                     <div class="entry" id="entry-575">
                        <h3 class="entry-header">Load Balancing Redirection</h3>
                        <div class="entry-content">
                           <div class="entry-body">
                              <ul>
  <li>Implemented a load balancing redirection scheme for cqweb</li>
</ul>
                              
                              <h2>Load Balancing CQ Web Servers based on Number of CQ Web Users</h2>

<p>The task at hand was to write a redirector that load balances amongst a number of CQ Web servers based on the number of CQ Web Users currently on each server. Additionally, based on how the user came into the CQ Web server farm, redirect them to the proper schema.</p>

<h3>Determining Load</h3>

<p>The old IIS CQ Web Server used to allow you to query the number of active CQ Web Users. The new Apache/Tomcat server only allows admins to do this. Additionally the admin need to be logged in, thus have a valid token. IBM/Rational suggests using Apache's server-status URL to determine load. However that only displays number of Apache requests in progress not number of CQ Web Users.</p>

<p>If ExtendedStatus is turned on then Apache lists each connection and the URL they are working on. By filtering "GET /cqweb" we can get a rough estimate of the number of CQ Web Users. There is a problem in that the redirector script cannot query the same web server that it's running on. Additionally this information can only be obtained if ExtendedStatus is turned on.</p>

<h2>Algorithm for selecting a server</h2>

<p>The algorithm for selecting a non busy server is described as:</p>

<p>Pick a lightly loaded server out of the pool. Note that if a server is not running with ExtendedStatus on then $cq_users will be undef. This is different than the case where the server has ExtendedStatus on but there just aren't any CQ Web users (which would be denoted by $cq_users = 0). Thus we may have the condition where:

<table cellspacing=0 cellpadding=2 border=1>
  <tbody>
    <tr>
      <th>Server</th>
      <th>cq_users</th>
      <th>ExtendedStatus</th>
    </tr>
    <tr>
      <td>server1</td>
      <td>undef</td>
      <td>off</td>
    </tr>
    <tr>
      <td>server2</td>
      <td>20</td>
      <td>on</td>
    </tr>
    <tr>
      <td>server3</td>
      <td>0</td>
      <td>on</td>
    </tr>
    <tr>
      <td>server4</td>
      <td>10</td>
      <td>on</td>
    </tr>
  </tbody>
<table>

<p>In such a case we wish to pick server3 since it has no current CQ web users.

<p>The algorithm used here will be to remove all servers from the pool who are not running with ExtendedStatus on since we cannot reliably tell how loaded the server is from the standpoint of CQ Web users. If, however, no servers have ExtendedStatus on (thus all $cq_users return as undef) then we will consider the $nbr_apache_requests. IOW $nbr_apache_requests is not equivalent with $cq_users and thus they cannot be compared together. But if no server is running with ExtendedStatus on we need to pick something!</p>

<p><b>Note:</b> If $random then a server is simply randomly chosen.</p>

<p>Unfortunately, given this algorithm, if we had the following situation:</p>
 
<table cellspacing=0 cellpadding=2 border=1>
  <tbody>
    <tr>
      <th>Server</th>
      <th>cq_users</th>
      <th>ExtendedStatus</th>
    </tr>
    <tr>
      <td>server1</td>
      <td>undef</td>
      <td>on</td>
    </tr>
    <tr>
      <td>server2</td>
      <td>undef</td>
      <td>off</td>
    </tr>
    <tr>
      <td>server3</td>
      <td>undef</td>
      <td>off</td>
    </tr>
    <tr>
      <td>server4</td>
      <td>10</td>
      <td>on</td>
    </tr>
  </tbody>
<table>

<p>Then this algorithm will always return server4.</p>

<p><b><font color=red>Important Note:</font></b> The web server doing the redirection cannot be queried. Attempting to do so hangs! Therefore it cannot participate in the server pool. It is recommended that another web server be set up as the redirector and the DNS name cqweb assigned to it. This web server can, however, participate by being a Clearquest Request Manager.</p>

<h3>Random Redirection</h3>

<p>The script can also redirect randomly instead of relying on load of CQ Web Users. Currently there are 3 servers in the pool. Only one of them has ExtendedStatus turned on. As such redirecting by load will always resolve to the one server using, the one running with ExtendedStatus on. This is not good. So currently it just picks a server randomly from the pool. This behavior is controlled by the <tt>lb</tt> parameter (currently defaulted to off meaning pick server randomly).

<h3>Defining the Server Pool</h3>

<p>The server pool is defined by a small file, servers.cfg, which simply list the servers participating in the pool. Servers can be added or removed dynamically.</p>

<h3>Mapping Redirection</h3>

<p>In the past users went to http://cqweb/&lt;area&gt;. These <areas> were HTML files in the DocumentRoot which redirected to a series of redirection scripts. It was hoped that HTTP_REFERER could be used to determine where to redirect the visitor. Unfortunately HTTP_REFERER is not guaranteed and indeed it's undefined on the web servers!</p>

<p>Instead one must specify the <tt>group</tt> parameter to the redirector script. The script then maintains a map between &lt;areas&gt; -> Schema/ContextIDs. If the group is not specified or not in the map then the user is redirected to the main login page. This is not viewed as a hardship because we need redirecting &lt;area&gt; files anyway. The new form of redirecting &lt;area&gt; file is:

<div class=code><pre>
&lt;html&gt;
&lt;head&gt;
&ltmdeta http-equiv="refresh" content="0; url=http://cqweb.itg.ti.com/cgi-bin/redirect.pl?group=&lt<i>area</i>&gt;&gt;
&lt;/head&gt;
</pre></div>

<h3>Redirect Map</h3>

<p>The redirect map, stored in redirect.map, is a file of key/value pairs. For example:</p>

<div class=code><pre>
CMDT:           &schema=CMDT.2003.06.00&contextid=CMDT
CSSD:           &schema=omap.2002.05.00&contextid=OMAPS
DLP-Play:       &schema=DLP.2003.06.00&contextid=Play
DLP:            &schema=DLP.2003.06.00&contextid=DLP
DMD-p:          &schema=DLP.2003.06.00&contextid=DMD-p
DMD:            &schema=DLP.2003.06.00&contextid=DMD
GCM:            &schema=CMDT.2003.06.00&contextid=GCM
HPALP:          &schema=HPA_MKT_LP&contextid=HPALP
LDM:            &schema=CMDT.2003.06.00&contextid=LDM
NV:             &schema=CMDT.2003.06.00&contextid=NV
SDO:            &schema=SDS.2003.06.00&contextid=SDSCM
SDO_TEST:       &schema=SDS_TST_DEV&contextid=SDSCM
WiMax:          &schema=WiMax.SR5&contextid=WiMax
mDTV:           &schema=mDTV.2003.06.00&contextid=MDTV
mDTV_play:      &schema=mDTV.2003.06.00&contextid=PLAY
</pre></div>

<h3>Parameters for redirect.pl</h3>

<p>The following parameters, specified in the URL, are supported by redirect.pl:</p>

<dl>
  <dt>group</dt>
    <dd>Specifies the key into the redirect.map for the schema/contextid. If not specified then defaults to main login page of the selected server</dd>

  <dt>lb</dt>
    <dd>If set then load balancing is attempted based on ExtendedStatus and CQ Web Users as described above. Default: undefined (off)</dd>

  <dt>debug</dt>
    <dd>If specified the user is not redirected rather debugging information is output.</dd>
</dl>
                              
                              <p class="entry-footer">
                                 <span class="post-footers">Posted by  at  2:35 PM</span> <span class="separator">|</span> <a class="permalink" href="http://defaria.com/blogs/Status/archives/000575.html">Permalink</a>
                                 
                                 
                              </p>
                           </div>
                        </div>
                     </div>
                     
                     

                     <h2 class="date-header">September 28, 2006</h2>
                     <a id="a000574"></a>
                     <div class="entry" id="entry-574">
                        <h3 class="entry-header">JVM Stack/Heap Sizes</h3>
                        <div class="entry-content">
                           <div class="entry-body">
                              <ul>
  <li>Looked into JVM stack and heap sizes on dfls83-85</li>
</ul>
                              
                              <p>As you know there have been service interruptions in CQWeb. I keep looking at the logs for clues. About the only consistent thing is an error similar to this:</p>

<div class=code><pre>
2006-09-28 00:10:20 Ajp13Processor[8009][15] process: invoke
java.net.SocketException: Connection reset by peer: socket write error
        at java.net.SocketOutputStream.socketWrite0(Native Method)
        at java.net.SocketOutputStream.socketWrite(Unknown Source)
        at java.net.SocketOutputStream.write(Unknown Source)
        at org.apache.ajp.Ajp13.send(Ajp13.java:525)
        at org.apache.ajp.RequestHandler.finish(RequestHandler.java:495)
        at org.apache.ajp.Ajp13.finish(Ajp13.java:395)
        at org.apache.ajp.tomcat4.Ajp13Response.finishResponse(Ajp13Response.java:196)
        at org.apache.ajp.tomcat4.Ajp13Processor.process(Ajp13Processor.java:464)
        at org.apache.ajp.tomcat4.Ajp13Processor.run(Ajp13Processor.java:551)
        at java.lang.Thread.run(Unknown Source)
</pre></div>

<p>Now "Connection reset by peer" could be an error that the process gets because the service has stopped so this could be more of a symptom than a cure. However searching for "Ajp13Processor socket write error" points me to <a href="http://mail-archives.apache.org/mod_mbox/tomcat-users/200203.mbox/%3C751828609.20020327090907@e-box.dk%3E">this
post</a> which suggests increasing the stack and heap sizes for the JVM. Problems that are intermittent can be consistent with running out of stack or heap size.<./p>

<p>According to the Clearquest Web Administration Guide:</p>

<blockquote>
  <hr size="2" width="100%">
  <h3>Controlling Java VM Memory Consumption </h3>

  <p>You can configure the memory consumption of Java processes used by New ClearQuest Web by adjusting the parameters in property files under the various components.</p>

  <h4>Windows </h4>

  <p>This section describes the configuration changes for New ClearQuest Web Java VM memory consumption for processes running on Microsoft Windows. To specify the VM memory consumption:</p>

  <ol>
    <li>Open the appropriate configuration file for the New ClearQuest Web component whose memory consumption you want to reconfigure. For the ClearQuest Web application:

      <table border="1" cellpadding="2" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <th align="left" valign="top">Component</th>
            <th align="left" valign="top">Configuration file</th>
          </tr>
          <tr>
            <td valign="top">Apache Tomcat Server</td>
            <td valign="top">C:\Program
Files\Rational\Common\rwp\bin\jk_service2.in.properties</td>
          </tr>
          <tr>
            <td valign="top">Rational Web Platform</td>
            <td valign="top">C:\Program
Files\Rational\Common\rwp\bin\jk_service2.properties</td>
          </tr>
        </tbody>
      </table>
      <br>
    <p>For the ClearQuest server:</p>
      <table border="1" cellpadding="2" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <th align="left" valign="top">Component</th>
            <th align="left" valign="top">Configuration file</th>
          </tr>
          <tr>
            <td valign="top">ClearQuest Request Manager</td>
            <td valign="top">C:\Program
Files\Rational\ClearQuest\cqweb\cqserver\requestmgr_service.properties</td>
          </tr>
          <tr>
            <td valign="top">ClearQuest Registry Server</td>
            <td valign="top">C:\Program
Files\Rational\ClearQuest\cqweb\cqregsvr\cqregsvr_service.properties</td>
          </tr>
        </tbody>
      </table>
    </li>
    <li>Modify the section shown below:<br>
      <br>
    <div class=code><pre>
# # JVM Options #
# Useful Options:
# -Xms2m = Initial heap size, modify for desired size
# -Xmx256m = Maximum heap size, modify for desired size
# -Xrs = Available in Jdk1.3.1 to avoid JVM termination during logoff
#
wrapper.jvm.options=-Xrs -Xms2m -Xmx256m
    </pre></div></li>
  </ol>
  <hr size="2" width="100%">
</blockquote>

<p>I looked at these config files on the three machines (dfls83-85) and they were pretty much set to the default:</p>

<div class=code><pre>
<font color=blue><b>Ltx0062320:</b></font><u>for server in 83 84 85; do grep
wrapper.jvm.options= //dfls$server/Rational/Common/rwp/bin/jk_service2*properties
//dfls$server/Rational/ClearQuest/cqweb/cqserver/requestmgr_service.properties
//dfls
$server/Rational/ClearQuest/cqweb/cqregsvr/cqregsvr_service.properties;
done</u>
//dfls83/Rational/Common/rwp/bin/jk_service2.default.properties:wrapper.jvm.options=-Xrs
-Xms2m -Xmx256m<br>
//dfls83/Rational/Common/rwp/bin/jk_service2.in.properties:wrapper.jvm.options=-Xrs
-Xms2m -Xmx256m<br>
//dfls83/Rational/Common/rwp/bin/jk_service2.properties:wrapper.jvm.options=-Xrs
-Xms2m -Xmx256m<br>
//dfls83/Rational/ClearQuest/cqweb/cqserver/requestmgr_service.properties:wrapper.jvm.options=-Xrs<br>
//dfls83/Rational/ClearQuest/cqweb/cqregsvr/cqregsvr_service.properties:wrapper.jvm.options=-Xrs<br>
//dfls84/Rational/Common/rwp/bin/jk_service2.default.properties:wrapper.jvm.options=-Xrs
-Xms2m -Xmx256m<br>
//dfls84/Rational/Common/rwp/bin/jk_service2.in.properties:wrapper.jvm.options=-Xrs
-Xms2m -Xmx256m<br>
//dfls84/Rational/Common/rwp/bin/jk_service2.properties:wrapper.jvm.options=-Xrs
-Xms2m -Xmx256m<br>
//dfls84/Rational/ClearQuest/cqweb/cqserver/requestmgr_service.properties:wrapper.jvm.options=-Xrs<br>
//dfls84/Rational/ClearQuest/cqweb/cqregsvr/cqregsvr_service.properties:wrapper.jvm.options=-Xrs<br>
//dfls85/Rational/Common/rwp/bin/jk_service2.default.properties:wrapper.jvm.options=-Xrs
-Xms2m -Xmx256m<br>
//dfls85/Rational/Common/rwp/bin/jk_service2.in.properties:wrapper.jvm.options=-Xrs
-Xms2m -Xmx256m<br>
//dfls85/Rational/Common/rwp/bin/jk_service2.properties:wrapper.jvm.options=-Xrs
-Xms2m -Xmx256m<br>
//dfls85/Rational/ClearQuest/cqweb/cqserver/requestmgr_service.properties:wrapper.jvm.options=-Xrs<br>
//dfls85/Rational/ClearQuest/cqweb/cqregsvr/cqregsvr_service.properties:wrapper.jvm.options=-Xrs<br>
 </pre></div>

</blockquote>
  <p>All these machines have 2 gig of main memory and largely just serve CQWeb. Indeed the CQWeb service processes are consuming most of the memory:</p>

<div align="center"><img title="dfls83"  src="/blogs/Status/images/dfls83.jpg" alt="" height="541"  width="524">
<b>dfls83</b><br>
<img title="dfls84" src="/blogs/Status/images/dfls84.jpg" alt=""  height="545" width="525">
<b>dfls84</b>
<br>
<img title="dfls85" src="/blogs/Status/images/dfls85.jpg" alt="" height="577" width="528">
<b>dfls85</b>
</div>

<p>I think we should try setting at least the following:</p>

<div class=code><pre>
wrapper.jvm.options=-Xrs -Xms128m -Xmx512m
</pre></div>

<p>A restart of all CQ Web services would probably be needed for the changes to become effective. The above settings start off the jvm @ 128m for all 4 processes thus a total memory footprint of 512 Meg and limit each process to 512 Meg max for a total footprint of 2 Gig (when full). We might want to bounce this idea off IBM/Rational support to see if all 4 process should have the same settings or if we show vary
them.</p>
                              
                              <p class="entry-footer">
                                 <span class="post-footers">Posted by  at 11:53 AM</span> <span class="separator">|</span> <a class="permalink" href="http://defaria.com/blogs/Status/archives/000574.html">Permalink</a>
                                 
                                 
                              </p>
                           </div>
                        </div>
                     </div>
                     
                     

                     <h2 class="date-header">September 27, 2006</h2>
                     <a id="a000570"></a>
                     <div class="entry" id="entry-570">
                        <h3 class="entry-header">OMAPS.pm bug</h3>
                        <div class="entry-content">
                           <div class="entry-body">
                              <ul>
  <li>Tracked down and fixed minor bug in OMAPS</li>
</ul>
                              
                              <p>I found a minor bug in OMAPS.pm that is called from the CSSD ClearQuest Account Creation page (http://dfls85/cgi-bin/create.pl). The error appears in the log files as:</p>

<div class=code><pre>
[Wed Sep 27 10:52:39 2006] [error] [client 128.247.39.85] [Wed Sep 27 10:52:39 2006] 
create.pl: Useless use of concatenation (.) or string in void context at OMAPS.pm line 318, &lt;CNF&gt; line 139.
</pre></div>

<p>Line 318 of OMAPS.pm is:</p>
<div class=code><pre>
debug ("add user $data-&gt;{login_name} to team "<u><font color="#ff0000"><b>)</b></font></u> . $cgi-&gt;param("Team");
</pre></div>
But it should read:<br>
<div class=code><pre>
debug ("add user $data-&gt;{login_name} to team " . $cgi-&gt;param("Team")<u><font color="#009900"><b>)</b></font></u>;
</pre></div>

<p>As we are watching the log files carefully for signs of Clearquest web hangs and outages it would be helpful if this superfluous error were eliminated.</p>

<p>I fixed this by hand on dfls[83-85] but it should be fixed in the original.</p>
                              
                              <p class="entry-footer">
                                 <span class="post-footers">Posted by  at  9:08 AM</span> <span class="separator">|</span> <a class="permalink" href="http://defaria.com/blogs/Status/archives/000570.html">Permalink</a>
                                 
                                 
                              </p>
                           </div>
                        </div>
                     </div>
                     
                     

                     <h2 class="date-header">September 26, 2006</h2>
                     <a id="a000569"></a>
                     <div class="entry" id="entry-569">
                        <h3 class="entry-header">CQ log files</h3>
                        <div class="entry-content">
                           <div class="entry-body">
                              <ul>
  <li>Looked into yet another hang up with CQ web servers</li>
</ul>
                              
                              <h2>CQ Web logs</h2>

<p>We get a lot of errors in the logs of the form:</p>

<div class=code><pre>
[Tue Sep 26 11:08:51 2006] [error] [client 128.247.39.85] File does not exist: 
C:/Program Files/Rational/Common/rwp/webapps/cqweb/dct/html/images, referer: 
http://dfls85.itg.ti.com/cqweb/dct/html/download_en.html
[Tue Sep 26 11:08:51 2006] [error] [client 128.247.39.85] File does not exist:
C:/Program Files/Rational/Common/rwp/webapps/cqweb/dct/html/images, referer:
http://dfls85.itg.ti.com/cqweb/dct/html/download_en.html
</pre></div>

These errors are not a big deal except they cloud the log files with meaningless stuff that you need to skip over all the time. I decided to look into this and see where they were coming from. In the file .../rwp/webapps/wre/common/script/common.js there appeared the following code:

<div class=code><pre>
var arrowOff=new Image();
     arrowOff.src="images/shim.gif";
var arrowOn=new Image();
      arrowOn.src="images/arrow_red.gif" ;
</pre></div>

<p>This appears to be causing the problem so I updated that JavaScript to:</p>

<div class=code><pre>
var arrowOff=new Image();
    arrowOff.src="/wre/common/images/shim.gif";
var arrowOn=new Image();
        arrowOn.src="/wre/common/images/arrow_red.gif" ;
</pre></div>

<p>I'm not sure if this is a Rational problem or something that TI has done but with the above fix the error seems to go away. Well at least for me. I suspect others are still generating the error because JavaScript is cached by the browser. Hopefully as people restart there browsers this will go away.</p>

<p>Additionally the following error is still appearing in the logs:</p>

<div class=code><pre>
[Mon Sep 25 20:31:06 2006] [error] [client 172.24.80.20] File does not exist:
C:/Program Files/Rational/Common/rwp/htdocs/favicon.ico
</pre></div>

<p>I've put a favicon.ico in the proper area on dfls85. The error seems to have diminished however I don't see a favicon in the browser so I'm not sure if this is working.</p>

<p>The two "fixes" above will need to be replicated to the other servers (dfls83 and 84) at some time.</p>

<p>Finally another error shows up:</p>

<div class=code><pre>
[Tue Sep 26 18:31:18 2006] [error] [client 128.247.39.85] [Tue Sep 26 18:31:18 2006] create.pl: 
Useless use of concatenation (.) or string in void context at OMAPS.pm line 318, <CNF> line 139.
</pre></div>

<p>This seems to be an error in CSSD's code which is located under .../Rational/cgi-bin. Going to <a href="http://dfls85/cgi-bin/create.pl">http://dfls85/cgi-bin/create.pl</a> first redirects me to TI's authentication web page but then back to, in my case, <a href="http://dfls85/cgi-bin/create.pl?stoken=nJAROWWcvXf2s4lwHoGETsko1vphx%2fLqHxNu7IU4L6axrg6DrEJiVoIi8ACLnoycJTlPsGJlCDLr3MhbcRx4DXgvut4ea6d%2bU%2bWzQR3oBpa6NsxSH7EPctkp96%2b9UkgIHfwh%2fWYSI0pO1wu6uHVcGgpT5tAuSpF0a3vBMgRZN8hoU0TPYJEQ9z6nNI99fKhjRh6SRNDmDdM%3d">here</a>. Going to that page generates this error in the error log everytime.</p>
                              
                              <p class="entry-footer">
                                 <span class="post-footers">Posted by  at  4:32 PM</span> <span class="separator">|</span> <a class="permalink" href="http://defaria.com/blogs/Status/archives/000569.html">Permalink</a>
                                 
                                 
                              </p>
                           </div>
                        </div>
                     </div>
                     
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
</body>
</html>
