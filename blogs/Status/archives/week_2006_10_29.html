<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
   <meta name="generator" content="Movable Type 5.2.3" />

   <link rel="stylesheet" href="http://defaria.com/blogs/Status/styles-site.css" type="text/css" />
   <link rel="alternate" type="application/atom+xml" title="Atom" href="http://defaria.com/blogs/Status/atom.xml" />
   <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="http://defaria.com/blogs/Status/index.xml"$>" />

   <title>Status for Andrew DeFaria: October 29, 2006 - November  4, 2006 Archives</title>

   <link rel="start" href="http://defaria.com/blogs/Status/" title="Home" />
   <link rel="prev" href="http://defaria.com/blogs/Status/archives/week_2006_10_22.html" title="October 22, 2006 - October 28, 2006" />
   <link rel="next" href="http://defaria.com/blogs/Status/archives/week_2006_11_05.html" title="November  5, 2006 - November 11, 2006" />
</head>
<body class="layout-one-column">
   <div id="container">
      <div id="container-inner" class="pkg">

         <div id="banner">
            <div id="banner-inner" class="pkg">
               <h1 id="banner-header"><a href="http://defaria.com/blogs/Status/" accesskey="1">Status for Andrew DeFaria</a></h1>
               <h2 id="banner-description">Searchable status reports and work log</h2>
            </div>
         </div>

         <div id="pagebody">
            <div id="pagebody-inner" class="pkg">
               <div id="alpha">
                  <div id="alpha-inner" class="pkg">
                     
                     <p class="content-nav">
                        <a href="http://defaria.com/blogs/Status/archives/week_2006_10_22.html">&laquo; October 22, 2006 - October 28, 2006</a> |
                        <a href="http://defaria.com/blogs/Status/">Main</a>
                        | <a href="http://defaria.com/blogs/Status/archives/week_2006_11_05.html">November  5, 2006 - November 11, 2006 &raquo;</a>
                     </p>
                     
                     
                     

                     <h2 class="date-header">November  3, 2006</h2>
                     <a id="a000589"></a>
                     <div class="entry" id="entry-589">
                        <h3 class="entry-header">Convertdb</h3>
                        <div class="entry-content">
                           <div class="entry-body">
                              <ul>
  <li>Converted UK Users -> GPDB</li>

  <li>Converted UK Sites -> GPDB</li>
</ul
                              
                              <p class="entry-footer">
                                 <span class="post-footers">Posted by  at  9:37 AM</span> <span class="separator">|</span> <a class="permalink" href="http://defaria.com/blogs/Status/archives/000589.html">Permalink</a>
                                 
                                 
                              </p>
                           </div>
                        </div>
                     </div>
                     
                     

                     <h2 class="date-header">October 31, 2006</h2>
                     <a id="a000588"></a>
                     <div class="entry" id="entry-588">
                        <h3 class="entry-header">Cloning done</h3>
                        <div class="entry-content">
                           <div class="entry-body">
                              <ul>
  <li>Implemented cloning procedure for DMD/CQ</li>
</ul>
                              
                              <h3>How to clone a parent CQ record to a child</h3>

<p>You would think that this would be clearly documented in the CQ manual but it isn't. The requirement is clear enough - "implement parent/child relationships for a CQ record... Oh and when a child is created could you copy everything from the parent and we'll change what's different in the child".</p>

<p>Implementing a parent/child relationship is pretty clear and documented - basically you create a reference link in the current record back to itself. CQ even has a parent/child control that handles manipulating the relationship allowing the user the controls to link in existing records, delete a parent/child relationship or add a new record as a child of this record. But there is nothing in there about copying data from the parent to the child. This you must do with hooks. But how to code the hooks?</p>

<p>I found a method for doing this and implemented the following. The trick is to add pre and post hooks to the <b>New</b> button of the parent/child control. This button is selected when the user wishes to add a new child record to this parent. The pre action hook, created as a <i>Record Script</i> set a session wide variable saying "Hey I'm adding a new child record to this parent". This variable contains the ID of the parent. The following code accomplishes this:</p>

<div class=code><pre>
my $session = $entity->GetSession;

$session->NameValue ("ParentID", $entity->GetFieldValue ("id")->GetValue);
</pre></div>

<p>After creating this record script add it as the pre-action hook for the new button. Don't forget to toggle the Enable for CQ Web (I don't really understand why you would ever not toggle that).</p>

<p>For the post-action script you are basically saying "Hey I'm no longer adding a new child record to this parent" with the following code:

<div class=code><pre>
my $session = $entity->GetSession;

$session->NameValue ("ParentID", "");
</pre></div>

<p>What this does is effectively bound the time you are in this unique situation - any other time the global session variable ParentID will be blank. Now the cloning can begin...</p>

<p>In the default value hooks for each field you want cloned place the following call:</p>

<div class=code><pre>
CloneField ($fieldname);
</pre></div>

<p>This is written as a call to a Global Script since the code will always be the same and because you'll have to do this for each field that you wish cloned.</p>

<p>Finally, create the following Global Script:</p>

<div class=code><pre>
sub CloneField {
  my $fieldname = shift;
    
  # Check session wide global, ParentID, and if set retrieve
  # the parent record and clone this field
  my $session  = $entity->GetSession;
  my $parentID = $session->GetNameValue ("ParentID");

  if ($parentID ne "") {
    # If ParentID is not blank then we are adding a subtask.
    # Copy this field from the parent to this new child.

    # Get the parent record
    my $parent = $session->GetEntity ("ChangeRequest", $parentID);

    # Set the child field
    $entity->SetFieldValue (
	$fieldname,
	$parent->GetFieldValue ($fieldname)->GetValue
    );
  } # if
} # CloneField
</pre></div>

<p>This script checks to see if the session global "ParentID" is not blank, indicating that we are in this special mode of adding a new child to an existing parent, and if so, gets the parent record and the field value based on the passed in field name. Finally it sets the field value based on the field name to that of the value of the corresponding parent's field value.</p>
                              
                              <p class="entry-footer">
                                 <span class="post-footers">Posted by  at 11:18 AM</span> <span class="separator">|</span> <a class="permalink" href="http://defaria.com/blogs/Status/archives/000588.html">Permalink</a>
                                 
                                 
                              </p>
                           </div>
                        </div>
                     </div>
                     
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
</body>
</html>
